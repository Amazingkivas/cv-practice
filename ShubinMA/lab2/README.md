# Практическая работа №2. Детектирование объектов на изображениях с использованием библиотеки OpenCV

## Описание программы

Программа реализует детектирование объектов на изображениях или видео с использованием предобученной модели YOLOv4 через библиотеку OpenCV.

## Реализованные алгоритмы

### 1) Предобработка изображения

Перед передачей изображения модели необходимо произвести его предобработку - приведение к некоторому стандартному виду, с которым способна работать модель. Для этого производятся следующие действия (числа взяты из документации к модели YOLOv4): 

1) Изменение размера до фиксированного (посредством масштабирования): 608x608 пикселей.
2) Нормализация значений изображения: из вектора значений каждого пикселя вычитается фиксированное среднее значение (в данном случае `(0, 0, 0)`), и каждый его элемент приводится в нужный диапазон (через домножение на `1/255`).
3) Преобразование в формат Blob, являющийся стандартным контейнером, используемым при работе с нейронными сетями в библиотеке OpenCV.

Все указанные действия производятся засчёт встроенной функции `cv.dnn.blobFromImage`.

### 2) Обработка выхода сети

После подачи изображения в модель, генерируется выход, состоящий из множества обнаружений, каждое из которых включает следующие последовательно расположенные элементы:

1) Описание detection box для данного предсказания в виде 4 значений: нормированные координаты центра, нормированная ширина, нормировванная высота. Домножив значения на ширину или высоту изображения, можно получить настоящие значения.
2) Описание вероятности принадлежности объекта внутри detection box к одному из классов в виде вектора из 80 значений (количество классов в датасете COCO, на котором была натренирована модель).

Полученный вывод преобразуется, и каждое обнаружение приводится к иному описанию:

1) Наибольшая вероятность принадлежности к классу (считаем это вероятностью данного обнаружения).
2) Номер класса, у которого наибольшая вероятность.
3) Описания окаймляющего прямоугольника в формате: координаты левой верхней вершины в пикселях, ширина и высота в пикселях.

### 3) Постобработка

Поскольку исходный вывод сети может содержать множество окаймляющих прямоугольников для одного и того же объекта, производится удаление "лишних" с помощью алгоритма Non-Maximum Suppression (NMS).

Алгоритм выглядит следующим образом:
1) Удаляются обнаружения, вероятность которых ниже пороговой вероятности.
2) Сравниваются все окаймляющие прямоугольники, и среди тех, перекрытие которых выше порогового, выбирается та, вероятность которой наибольшая, а остальные удаляются.
3) В результате повторного выполнения до момента, пока не останется окаймляющих прямоугольников, перекрытие которых выше порогового, остаются только уникальные рамки для каждого объекта.

Все указанные действия производятся засчёт встроенной функции `cv.dnn.NMSBoxes`.

### 4) Отображение результатов

После выполнения указанных выше действий на исходное изображение или видео накладываются прямоугольники, соответствующие полученным окаймляющим прямоугольникам, с подписями, указывающими на предсказанный класс и вероятность принадлежности к нему. Цвета прямоугольников и надписей одинаковы среди одного класса, и для простоты выбираются случайно.

## Описание параметров запуска программы

При запуске через командную строку могут быть указаны следующие параметры:

- `--mode (-m)`: Режим работы (изображение `Image`, видео `Video`, обработка видео в реальном времени `VideoStream`).
- `--input (-i)`: Путь к входному изображению или видео.
- `--output (-o)`: Путь к файлу для записи полученных результатов. Если не указан, запись результатов производиться не будет.
- `--config (-c)`: Путь к файлу конфигурации модели.
- `--weights (-w)`: Путь к файлу весов модели.
- `--labels (-l)`: Путь к файлу меток классов.
- `--conf_threshold (-ct)`: Пороговая вероятность. Стандартное значение: 0,5.
- `--nms_threshold (-nt)`: Пороговое перекрытие окаймляющих прямоугольников. Стандартное значение: 0,5.

## Пример использования
1) Для просмотра доступных параметров:
   ```bash
   python lab2.py --help
2) Для обработки изображения:
   ```bash
   python lab2.py -m Image -i test_img.jpg -c yolov4tf.cfg -w yolov4tf.weights -l coco_80cl.txt
3) Для обработки видео:
   ```bash
   python lab2.py -m Video -i test_vid.mp4 -c yolov4tf.cfg -w yolov4tf.weights -l coco_80cl.txt
4) Для обработки видео в реальном времени:
   ```bash
   python lab2.py -m VideoStream -i test_vid.mp4 -c yolov4tf.cfg -w yolov4tf.weights -l coco_80cl.txt
